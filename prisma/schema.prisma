generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  User              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model CompanySettings {
  id                 String    @id
  companyName        String
  address            String?
  city               String?
  state              String?
  zipCode            String?
  phone              String?
  email              String?
  website            String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime
  logoUrl            String?
  organizationId     String?   @unique
  overtimeEnabled    Boolean   @default(false)
  overtimeRate       Float?    @default(1.5)
  overtimeType       String?   @default("weekly40")
  payDay             String?   @default("friday")
  payPeriodStartDate DateTime?
  payPeriodType      String?   @default("weekly")

  @@index([organizationId])
}

model Customer {
  id             String      @id
  name           String
  phone          String?
  email          String?
  company        String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime
  organizationId String?
  Invoice        Invoice[]
  Job            Job[]
  Quotation      Quotation[]

  @@index([organizationId])
}

model IncidentEmployee {
  id               String         @id
  incidentReportId String
  userId           String
  role             String         @default("INVOLVED")
  IncidentReport   IncidentReport @relation(fields: [incidentReportId], references: [id], onDelete: Cascade)
  User             User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([incidentReportId, userId])
  @@index([incidentReportId])
  @@index([userId])
}

model IncidentReport {
  id               String             @id
  title            String
  description      String
  incidentDate     DateTime
  location         String
  injuryDetails    String?
  witnesses        String?
  status           String             @default("OPEN")
  severity         String             @default("LOW")
  photos           String[]
  organizationId   String
  createdById      String
  jobId            String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  IncidentEmployee IncidentEmployee[]
  User             User               @relation(fields: [createdById], references: [id], onDelete: Cascade)
  Job              Job?               @relation(fields: [jobId], references: [id])
  Organization     Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([createdById])
  @@index([jobId])
  @@index([organizationId])
  @@index([severity])
  @@index([status])
}

model InventoryAdjustment {
  id             String        @id
  itemId         String
  userId         String
  quantityChange Int
  reason         String?
  notes          String?
  createdAt      DateTime      @default(now())
  InventoryItem  InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  User           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model InventoryItem {
  id                  String                @id
  name                String
  sku                 String?               @unique
  description         String?
  category            String?
  quantity            Int                   @default(0)
  unit                String                @default("pcs")
  minStockLevel       Int                   @default(0)
  location            String?
  supplier            String?
  costPerUnit         Float?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  organizationId      String?
  photos              String?
  InventoryAdjustment InventoryAdjustment[]

  @@index([organizationId])
}

model Invoice {
  id             String        @id
  jobId          String?
  customerId     String?
  customerName   String?
  customerEmail  String?
  status         String        @default("DRAFT")
  issueDate      DateTime      @default(now())
  dueDate        DateTime?
  total          Float         @default(0)
  balance        Float         @default(0)
  notes          String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime
  invoiceNumber  String?       @unique
  sentDate       DateTime?
  releaseDate    DateTime?
  collectionDate DateTime?
  creditDate     DateTime?
  pdfFiles       String?
  remarks        String?
  deletedAt      DateTime?
  organizationId String?
  Customer       Customer?     @relation(fields: [customerId], references: [id])
  Job            Job?          @relation(fields: [jobId], references: [id])
  InvoiceLine    InvoiceLine[]
  Payment        Payment[]

  @@index([organizationId])
}

model InvoiceLine {
  id          String  @id
  invoiceId   String
  description String
  quantity    Float   @default(1)
  rate        Float   @default(0)
  amount      Float   @default(0)
  Invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

model Job {
  id                        String            @id
  title                     String
  description               String?
  status                    String            @default("NOT_STARTED")
  priority                  String            @default("MEDIUM")
  assignedTo                String?
  createdBy                 String
  customerId                String?
  pricingType               String            @default("FIXED")
  estimatedPrice            Float?
  finalPrice                Float?
  dueDate                   DateTime?
  createdAt                 DateTime          @default(now())
  updatedAt                 DateTime
  estimatedHours            Float?
  organizationId            String?
  jobNumber                 String?           @unique
  IncidentReport            IncidentReport[]
  Invoice                   Invoice[]
  User_Job_assignedToToUser User?             @relation("Job_assignedToToUser", fields: [assignedTo], references: [id])
  User_Job_createdByToUser  User              @relation("Job_createdByToUser", fields: [createdBy], references: [id], onDelete: Cascade)
  Customer                  Customer?         @relation(fields: [customerId], references: [id])
  JobActivity               JobActivity[]
  JobAssignment             JobAssignment[]
  JobExpense                JobExpense[]
  MaterialRequest           MaterialRequest[]
  QCRecord                  QCRecord[]
  Quotation                 Quotation[]
  ReworkEntry               ReworkEntry[]
  TimeEntry                 TimeEntry[]

  @@index([organizationId])
}

model JobActivity {
  id          String   @id
  jobId       String
  userId      String
  type        String
  timeEntryId String?
  notes       String?
  images      String?
  createdAt   DateTime @default(now())
  Job         Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model JobAssignment {
  id        String   @id
  jobId     String
  userId    String
  createdAt DateTime @default(now())
  Job       Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([jobId, userId])
  @@index([jobId])
  @@index([userId])
}

model JobExpense {
  id             String   @id
  jobId          String
  userId         String
  category       String
  description    String
  amount         Float
  quantity       Float    @default(1)
  unit           String?
  receiptUrl     String?
  notes          String?
  expenseDate    DateTime @default(now())
  createdAt      DateTime @default(now())
  organizationId String?
  Job            Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  User           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

model ManualFile {
  id             String        @id
  name           String
  originalName   String
  fileType       String
  fileSize       Int
  fileUrl        String
  folderId       String?
  createdBy      String
  createdAt      DateTime      @default(now())
  updatedAt      DateTime
  organizationId String?
  User           User          @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  ManualFolder   ManualFolder? @relation(fields: [folderId], references: [id], onDelete: Cascade)

  @@index([folderId])
  @@index([organizationId])
}

model ManualFolder {
  id                 String         @id
  name               String
  parentId           String?
  createdBy          String
  createdAt          DateTime       @default(now())
  updatedAt          DateTime
  organizationId     String?
  ManualFile         ManualFile[]
  User               User           @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  ManualFolder       ManualFolder?  @relation("ManualFolderToManualFolder", fields: [parentId], references: [id], onDelete: Cascade)
  other_ManualFolder ManualFolder[] @relation("ManualFolderToManualFolder")

  @@index([organizationId])
  @@index([parentId])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model MaterialRequest {
  id                String    @id
  jobId             String?
  userId            String
  itemName          String
  quantity          Int
  unit              String
  description       String?
  priority          String    @default("MEDIUM")
  status            String    @default("PENDING")
  requestedDate     DateTime  @default(now())
  fulfilledDate     DateTime?
  notes             String?
  requestNumber     String?
  recommendedAction String?
  dateDelivered     DateTime?
  orderStatus       String?
  amount            Float?
  organizationId    String?
  Job               Job?      @relation(fields: [jobId], references: [id])
  User              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

model Notification {
  id             String    @id
  userId         String
  title          String
  message        String?
  type           String    @default("INFO")
  isRead         Boolean   @default(false)
  linkUrl        String?
  createdAt      DateTime  @default(now())
  readAt         DateTime?
  organizationId String?
  User           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId, createdAt])
  @@index([userId, isRead])
}

model OCRCorrection {
  id                 String   @id
  receiptText        String
  originalAmount     Float
  correctedAmount    Float
  correctLinePattern String
  storeName          String?
  strategy           String
  formatId           String?
  userId             String
  createdAt          DateTime @default(now())

  @@index([formatId])
  @@index([storeName])
  @@index([userId])
}

model OCRExtractionSuccess {
  id              String   @id
  receiptText     String
  extractedAmount Float
  storeName       String?
  strategy        String
  linePattern     String
  formatId        String?
  userId          String
  createdAt       DateTime @default(now())

  @@index([formatId])
  @@index([storeName])
  @@index([userId])
}

model OCRFormatDetection {
  id                String   @id
  detectedStoreName String
  correctStoreName  String
  ocrTextSnippet    String
  formatId          String?
  wasCorrect        Boolean
  userId            String
  createdAt         DateTime @default(now())

  @@index([correctStoreName])
  @@index([detectedStoreName])
  @@index([userId])
}

model OCRPatternStats {
  id           String   @id
  pattern      String   @unique
  successCount Int      @default(0)
  failureCount Int      @default(0)
  storeName    String?
  formatId     String?
  updatedAt    DateTime

  @@index([formatId])
  @@index([storeName])
}

model OperationsCommonFile {
  id                     String                  @id
  name                   String
  originalName           String
  fileType               String
  fileSize               Int
  fileUrl                String
  folderId               String?
  createdBy              String
  createdAt              DateTime                @default(now())
  updatedAt              DateTime
  organizationId         String?
  User                   User                    @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  OperationsCommonFolder OperationsCommonFolder? @relation(fields: [folderId], references: [id], onDelete: Cascade)

  @@index([folderId])
  @@index([organizationId])
}

model OperationsCommonFolder {
  id                           String                   @id
  name                         String
  parentId                     String?
  createdBy                    String
  createdAt                    DateTime                 @default(now())
  updatedAt                    DateTime
  organizationId               String?
  OperationsCommonFile         OperationsCommonFile[]
  User                         User                     @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  OperationsCommonFolder       OperationsCommonFolder?  @relation("OperationsCommonFolderToOperationsCommonFolder", fields: [parentId], references: [id], onDelete: Cascade)
  other_OperationsCommonFolder OperationsCommonFolder[] @relation("OperationsCommonFolderToOperationsCommonFolder")

  @@index([organizationId])
  @@index([parentId])
}

model Organization {
  id               String           @id
  name             String
  slug             String           @unique
  isActive         Boolean          @default(true)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime
  jobNumberPrefix  String           @default("JOB")
  jobNumberCounter Int              @default(0)
  jobNumberYear    Int?
  IncidentReport   IncidentReport[]

  @@index([isActive])
  @@index([slug])
}

model Payment {
  id          String   @id
  invoiceId   String
  amount      Float
  method      String?
  notes       String?
  paymentDate DateTime @default(now())
  createdAt   DateTime @default(now())
  Invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

model PushToken {
  id        String   @id
  token     String   @unique
  platform  String
  deviceId  String?
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime

  @@index([platform])
  @@index([userId])
}

model QCRecord {
  id        String   @id
  jobId     String
  qcUserId  String
  qcStatus  String
  qcScore   Float
  notes     String?
  photos    String?
  createdAt DateTime @default(now())
  Job       Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [qcUserId], references: [id], onDelete: Cascade)
}

model Quotation {
  id                   String          @id
  quotationNumber      String?         @unique
  jobId                String?
  customerId           String?
  customerName         String?
  customerEmail        String?
  customerAddress      String?
  customerPhone        String?
  status               String          @default("DRAFT")
  issueDate            DateTime        @default(now())
  validUntil           DateTime?
  total                Float           @default(0)
  notes                String?
  paymentBank          String?
  paymentAccountName   String?
  paymentAccountNumber String?
  preparedByName       String?
  preparedByTitle      String?
  shippingFee          Float           @default(0)
  createdAt            DateTime        @default(now())
  updatedAt            DateTime
  organizationId       String?
  Customer             Customer?       @relation(fields: [customerId], references: [id])
  Job                  Job?            @relation(fields: [jobId], references: [id])
  QuotationLine        QuotationLine[]

  @@index([organizationId])
}

model QuotationLine {
  id          String    @id
  quotationId String
  description String
  quantity    Float     @default(1)
  rate        Float     @default(0)
  amount      Float     @default(0)
  Quotation   Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
}

model ReworkEntry {
  id                                       String   @id
  jobId                                    String
  responsibleUserId                        String?
  createdByUserId                          String
  reason                                   String
  createdAt                                DateTime @default(now())
  User_ReworkEntry_createdByUserIdToUser   User     @relation("ReworkEntry_createdByUserIdToUser", fields: [createdByUserId], references: [id], onDelete: Cascade, map: "ReworkEntry_createdBy_fkey")
  Job                                      Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  User_ReworkEntry_responsibleUserIdToUser User?    @relation("ReworkEntry_responsibleUserIdToUser", fields: [responsibleUserId], references: [id], map: "ReworkEntry_responsibleUser_fkey")
}

model SOPDocument {
  id             String   @id
  title          String
  content        String
  folderId       String?
  createdBy      String
  createdAt      DateTime @default(now())
  updatedAt      DateTime
  organizationId String?

  @@index([folderId])
  @@index([organizationId])
}

model SOPTemplate {
  id             String   @id
  name           String
  description    String?
  content        String
  createdBy      String
  createdAt      DateTime @default(now())
  updatedAt      DateTime
  organizationId String?

  @@index([organizationId])
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model TimeEntry {
  id                      String    @id
  userId                  String
  jobId                   String?
  clockIn                 DateTime
  clockOut                DateTime?
  notes                   String?
  images                  String?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime
  durationHours           Float?
  isRework                Boolean   @default(false)
  clockInNotes            String?
  breakStart              DateTime?
  breakEnd                DateTime?
  organizationId          String?
  capMinutes              Int       @default(960)
  flagStatus              String    @default("NONE")
  lastStateChangeAt       DateTime?
  overCapAt               DateTime?
  state                   String    @default("WORKING")
  workAccumSeconds        Int       @default(0)
  correctionAppliedAt     DateTime?
  correctionNote          String?
  wrongRecordedNetSeconds Int?
  Job                     Job?      @relation(fields: [jobId], references: [id])
  User                    User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

model User {
  id                                              String                   @id
  name                                            String?
  email                                           String?                  @unique
  phone                                           String?
  passwordHash                                    String?
  role                                            String                   @default("EMPLOYEE")
  hourlyRate                                      Float?
  isVerified                                      Boolean                  @default(false)
  verificationCode                                String?
  codeExpiresAt                                   DateTime?
  createdAt                                       DateTime                 @default(now())
  updatedAt                                       DateTime
  resetToken                                      String?
  resetTokenExpiresAt                             DateTime?
  birthDate                                       DateTime?
  gender                                          String?
  status                                          String                   @default("APPROVED")
  permissions                                     String?                  @default("{}")
  isSuperAdmin                                    Boolean                  @default(false)
  organizationId                                  String?
  lastPaidDate                                    DateTime?
  Account                                         Account[]
  IncidentEmployee                                IncidentEmployee[]
  IncidentReport                                  IncidentReport[]
  InventoryAdjustment                             InventoryAdjustment[]
  Job_Job_assignedToToUser                        Job[]                    @relation("Job_assignedToToUser")
  Job_Job_createdByToUser                         Job[]                    @relation("Job_createdByToUser")
  JobActivity                                     JobActivity[]
  JobAssignment                                   JobAssignment[]
  JobExpense                                      JobExpense[]
  ManualFile                                      ManualFile[]
  ManualFolder                                    ManualFolder[]
  MaterialRequest                                 MaterialRequest[]
  Notification                                    Notification[]
  OperationsCommonFile                            OperationsCommonFile[]
  OperationsCommonFolder                          OperationsCommonFolder[]
  QCRecord                                        QCRecord[]
  ReworkEntry_ReworkEntry_createdByUserIdToUser   ReworkEntry[]            @relation("ReworkEntry_createdByUserIdToUser")
  ReworkEntry_ReworkEntry_responsibleUserIdToUser ReworkEntry[]            @relation("ReworkEntry_responsibleUserIdToUser")
  Session                                         Session[]
  TimeEntry                                       TimeEntry[]

  @@index([isSuperAdmin])
  @@index([organizationId])
}
